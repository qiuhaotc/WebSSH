@page "/Management"
@inject NavigationManager NavManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms

<h3>Management</h3>
<h4>Connected Sessions</h4>
<div class="row">
    @if (StaticUtils.ActiveSessionsModel != null && StaticUtils.ActiveSessionsModel.Sessions.Count > 0)
    {
        @foreach (var activeSession in StaticUtils.ActiveSessionsModel.Sessions)
        {
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <p>Name: @activeSession.Value.StoredSessionModel.DisplayName</p>
                        <p>Connected Date: @activeSession.Value.StartSessionDate</p>
                        <button class="btn btn-primary btn-sm" @onclick="() => CheckConnectedAndGotoShell(activeSession.Value)">Go To Shell</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => Disconnected(activeSession.Value)">Disconnected</button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    Empty
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Status))
    {
        <div class="card alert alert-danger col-md-12" role="alert">
            @Status
        </div>
    }
</div>

<hr />
<h4>
    Stored Sessions
    <button class="btn btn-primary btn-sm" @onclick="SaveChanges">Save to Local Storage</button>
    <button class="btn btn-success btn-sm" @onclick="ExportSessions">Export to JSON</button>
    <label class="btn btn-info btn-sm" style="margin-bottom: 0;">
        Import from JSON
        <InputFile OnChange="ImportSessions" accept=".json" style="display: none;" />
    </label>
</h4>
@if (!string.IsNullOrEmpty(ImportExportStatus))
{
    <div class="alert @(ImportExportStatus.Contains("Error") || ImportExportStatus.Contains("Failed") ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @ImportExportStatus
        <span style="cursor:pointer" @onclick="() => ImportExportStatus = string.Empty">➖</span>
    </div>
}
<div class="row">
    @if (ClientStoredSessionsModel != null && ClientStoredSessionsModel.Sessions.Count > 0)
    {
        @foreach (var storedSession in ClientStoredSessionsModel.Sessions)
        {
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <p>Name: @storedSession.DisplayName</p>
                        <p>Host: @storedSession.Host</p>
                        <p>Port: @storedSession.Port</p>
                        <p>User Name: @storedSession.UserName</p>
                        <p>Password: @(string.IsNullOrEmpty(storedSession.Password) ? string.Empty : "**********")</p>
                        <button class="btn btn-primary btn-sm" @onclick="() => GoToConnected(storedSession)">Connected</button>
                        <button class="btn btn-info btn-sm" @onclick="u => EditStoredSession(storedSession)">Edit</button>
                        <button class="btn btn-warning btn-sm" @onclick="u => CopySession(storedSession)">Copy</button>
                        <button class="btn btn-danger btn-sm" @onclick="u => DeleteStoredSession(storedSession)">Delete</button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    Empty
                </div>
            </div>
        </div>
    }
</div>

<hr />

<h5>
    Add or Edit Session Info
    <button type="button" class="btn btn-primary btn-sm" @onclick="SaveConnectInfo">Save Session Info</button>
</h5>
<div class="row">
    <div class="form-group col-md-4">
        <label for="DisplayName">Display Name</label>
        <input type="text" class="form-control" id="DisplayName" autocomplete="off" @bind-value="@ClientStoredSessionModelForEditOrAdd.DisplayName">
    </div>
    <div class="form-group col-md-4">
        <label for="RemoteHost">Remote Host Address</label>
        <input type="text" class="form-control" id="RemoteHost" autocomplete="off" @bind-value="@ClientStoredSessionModelForEditOrAdd.Host">
    </div>
    <div class="form-group col-md-4">
        <label for="Port">Port</label>
        <input type="number" class="form-control" id="Port" autocomplete="off" @bind-value="@ClientStoredSessionModelForEditOrAdd.Port">
    </div>
    <div class="form-group col-md-6">
        <label for="ServerUserName">User Name</label>
        <input type="text" class="form-control" id="ServerUserName" autocomplete="off" @bind-value="@ClientStoredSessionModelForEditOrAdd.UserName">
    </div>
    <div class="form-group  col-md-6">
        <label for="ServerPassword">Password</label>
        <input type="password" class="form-control" id="ServerPassword" autocomplete="new-password" @bind-value="@ClientStoredSessionModelForEditOrAdd.PasswordDecryped">
        <small id="PasswordHelp" class="form-text text-muted">The password will saved as base64 encoding on your local browser</small>
    </div>
</div>

@code {

    public string Status { get; set; }
    public string ImportExportStatus { get; set; }

    ClientStoredSessionModel ClientStoredSessionModelForEditOrAdd { get; set; } = new();

    ClientStoredSessionsModel ClientStoredSessionsModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ClientStoredSessionsModel = await LocalStorage.GetItemAsync<ClientStoredSessionsModel>(nameof(ClientStoredSessionsModel));

        if (ClientStoredSessionsModel == null)
        {
            ClientStoredSessionsModel = new ClientStoredSessionsModel();
        }

        try
        {
            var activeSessionsModel = await Http.GetFromJsonAsync<ServerResponse<List<ActiveSessionModel>>>("/api/Shell/ConnectedSessions");

            if (activeSessionsModel.StausResult == StausResult.Successful)
            {
                StaticUtils.ActiveSessionsModel.RemoveActiveSessions();

                foreach (var activeSession in activeSessionsModel.Response)
                {
                    StaticUtils.ActiveSessionsModel.AddActiveSession(activeSession);
                }
            }
            else
            {
                Status = activeSessionsModel.ExtraMessage;
            }
        }
        catch (Exception ex)
        {
            if (ex is HttpRequestException httpRequestException && httpRequestException.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                NavManager.NavigateTo("/Login");
            }
            else
            {
                Status = ex.Message;
            }
        }
    }

    async void SaveConnectInfo()
    {
        ClientStoredSessionsModel.AddOrUpdateStoredSessions(ClientStoredSessionModelForEditOrAdd);
        ClientStoredSessionModelForEditOrAdd = new ClientStoredSessionModel();
        await LocalStorage.SetItemAsync<ClientStoredSessionsModel>(nameof(ClientStoredSessionsModel), ClientStoredSessionsModel);
    }

    void EditStoredSession(ClientStoredSessionModel clientStoredSessionModel)
    {
        ClientStoredSessionModelForEditOrAdd = clientStoredSessionModel;
    }

    async void SaveChanges()
    {
        await LocalStorage.SetItemAsync<ClientStoredSessionsModel>(nameof(ClientStoredSessionsModel), ClientStoredSessionsModel);
    }

    void DeleteStoredSession(ClientStoredSessionModel clientStoredSessionModel)
    {
        ClientStoredSessionsModel.RemoveStoredSession(clientStoredSessionModel.UniqueKey);
    }

    void GoToConnected(ClientStoredSessionModel clientStoredSessionModel)
    {
        StaticUtils.ClientStoredSessionModel = clientStoredSessionModel.Clone();
        NavManager.NavigateTo("/Connected");
    }

    void CopySession(ClientStoredSessionModel clientStoredSessionModel)
    {
        ClientStoredSessionModelForEditOrAdd = clientStoredSessionModel.Clone(false);
        ClientStoredSessionModelForEditOrAdd.DisplayName = ClientStoredSessionModelForEditOrAdd.DisplayName + "_Copy";
        ClientStoredSessionsModel.AddOrUpdateStoredSessions(ClientStoredSessionModelForEditOrAdd);
    }

    async void CheckConnectedAndGotoShell(ActiveSessionModel activeSessionModel)
    {
        Status = null;

        try
        {
            var isConnected = await Http.GetFromJsonAsync<ServerResponse<bool>>("/api/Shell/IsConnected?uniqueId=" + activeSessionModel.UniqueKey);
            if (isConnected.StausResult == StausResult.Successful && isConnected.Response)
            {
                NavManager.NavigateTo("/Shell/" + activeSessionModel.UniqueKey);
            }
            else
            {
                StaticUtils.ActiveSessionsModel.RemoveActiveSession(activeSessionModel.UniqueKey);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Status = ex.Message;
            StateHasChanged();
        }
    }

    async void Disconnected(ActiveSessionModel activeSessionModel)
    {
        try
        {
            var disconnected = await Http.GetFromJsonAsync<ServerResponse<bool>>("/api/Shell/Disconnected?uniqueId=" + activeSessionModel.UniqueKey);
            if (disconnected.StausResult == StausResult.Successful && disconnected.Response)
            {
                StaticUtils.ActiveSessionsModel.RemoveActiveSession(activeSessionModel.UniqueKey);
            }
            else
            {
                Status = disconnected.ExtraMessage;
            }
        }
        catch (Exception ex)
        {
            Status = ex.Message;
        }

        StateHasChanged();
    }

    async Task ExportSessions()
    {
        try
        {
            if (ClientStoredSessionsModel == null || ClientStoredSessionsModel.Sessions.Count == 0)
            {
                ImportExportStatus = "Error: No sessions to export.";
                StateHasChanged();
                return;
            }

            var options = new JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            };
            var json = JsonSerializer.Serialize(ClientStoredSessionsModel, options);
            var fileName = $"webssh-sessions-{DateTime.Now:yyyyMMdd-HHmmss}.json";

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json)));

            ImportExportStatus = $"Successfully exported {ClientStoredSessionsModel.Sessions.Count} session(s) to {fileName}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ImportExportStatus = $"Error exporting sessions: {ex.Message}";
            StateHasChanged();
        }
    }

    async Task ImportSessions(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
            {
                ImportExportStatus = "Error: No file selected.";
                StateHasChanged();
                return;
            }

            if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
            {
                ImportExportStatus = "Error: Please select a JSON file.";
                StateHasChanged();
                return;
            }

            var maxFileSize = 1024 * 1024; // 1MB
            using var stream = file.OpenReadStream(maxFileSize);
            using var reader = new System.IO.StreamReader(stream);
            var json = await reader.ReadToEndAsync();

            var importedModel = JsonSerializer.Deserialize<ClientStoredSessionsModel>(json);

            if (importedModel == null || importedModel.Sessions == null)
            {
                ImportExportStatus = "Error: Invalid JSON format.";
                StateHasChanged();
                return;
            }

            var importCount = 0;
            var updateCount = 0;
            var skipCount = 0;

            foreach (var session in importedModel.Sessions)
            {
                var existing = ClientStoredSessionsModel.Sessions.FirstOrDefault(s => s.UniqueKey == session.UniqueKey);
                if (existing != null)
                {
                    // Ask user if they want to update existing sessions
                    var existingByName = ClientStoredSessionsModel.Sessions.FirstOrDefault(s =>
                        s.DisplayName == session.DisplayName && s.UniqueKey != session.UniqueKey);

                    if (existingByName != null)
                    {
                        // Generate new unique key to avoid conflicts
                        session.UniqueKey = Guid.NewGuid();
                        session.DisplayName = session.DisplayName + "_imported";
                    }

                    ClientStoredSessionsModel.AddOrUpdateStoredSessions(session);
                    updateCount++;
                }
                else
                {
                    var duplicateName = ClientStoredSessionsModel.Sessions.FirstOrDefault(s => s.DisplayName == session.DisplayName);
                    if (duplicateName != null)
                    {
                        session.DisplayName = session.DisplayName + "_imported";
                    }

                    ClientStoredSessionsModel.AddOrUpdateStoredSessions(session);
                    importCount++;
                }
            }

            await LocalStorage.SetItemAsync<ClientStoredSessionsModel>(nameof(ClientStoredSessionsModel), ClientStoredSessionsModel);

            ImportExportStatus = $"Successfully imported: {importCount} new session(s), {updateCount} updated, {skipCount} skipped.";
            StateHasChanged();
        }
        catch (JsonException jsonEx)
        {
            ImportExportStatus = $"Error: Invalid JSON format - {jsonEx.Message}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ImportExportStatus = $"Error importing sessions: {ex.Message}";
            StateHasChanged();
        }
    }
}
